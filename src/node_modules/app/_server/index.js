import path from "path"
import fs from "fs"
import toml from "toml"
import {Server} from "hapi"
import Inert from "inert"
import h2o2 from "h2o2"
import routes from "app/_server/routes"

const config = toml.parse(fs.readFileSync(path.resolve("conf/dev.toml"), "utf8"))

const server = new Server()
server.connection({
  labels: "app",
  host: config.server.host,
  port: config.server.port
})
server.connection({
  labels: "tile",
  host: config.tile.host,
  port: config.tile.port
})

server.register([Inert, h2o2], err => {
  if (err) {
    console.log("Load plugins failed", err)
  }
})

if (config.webpack.port) {
  server.route({
    method: "GET",
    path: config.webpack.publicPath + "{path*}",
    handler: {
      proxy: {
        host: config.webpack.host,
        port: config.webpack.port,
        passThrough: true,
        xforward: true
      }
    }
  })
}

server.route(routes)

server.start(() => {
  server.connections.forEach(connection => {
    console.log("Server " + connection.settings.labels + " running at: " + connection.info.uri)
    console.log(connection.table().map(route => route.path))
  })
})
