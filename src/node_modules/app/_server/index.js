import path from "path"
import {Server} from "hapi"
import Inert from "inert"
import h2o2 from "h2o2"
import routes from "app/_server/routes"

const serverConfig = require(path.resolve("config/server.dev"))
const webpackConfig = require(path.resolve("config/webpack.dev"))

const server = new Server()
server.connection(serverConfig.connection)

server.register([Inert, h2o2], err => {
  if (err) {
    console.log("Load plugins failed", err)
  }
})

if (serverConfig.devPort) {
  server.route({
    method: "GET",
    path: webpackConfig.output.publicPath + "{path*}",
    handler: {
      proxy: {
        host: serverConfig.connection.host,
        port: serverConfig.devPort,
        passThrough: true,
        xforward: true
      }
    }
  })
}

server.route(routes)

server.start(() => {
  console.log("Server running at port " + server.info.port)
  routes.forEach(route => {
    console.log(route.path)
  })
})
