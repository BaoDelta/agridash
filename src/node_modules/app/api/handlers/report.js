import {find, range} from "app/core/utils"
import sql from "app/core/utils/sql"
import random from "app/core/utils/random"
import reports from "app/web/mock/reports"

const rng = random()

export function getReport(request, reply) {
  reply(find(reports, "id", +request.params.id))
}

export function getReportViewData(request, reply) {
  const report = find(reports, "id", +request.params.id)
  const view = find(report.views, "id", +request.params.viewId)
  const sessionId = +request.query.sessionId
  const resultId = +request.query.resultId
  sql("georesult").select("timestamp").where({
    sessionid: sessionId,
    resultid: resultId
  }).then(found => {
    if (found.length) {
      reply(view)
      return
    }
    const data = []
    const test = {}
    range(1, 900).forEach(stateId => {
      test[stateId] = "" + rng.natural({min: 1, max: 4})
    })
    data.push(test)
    sql("georesult").insert({
      sessionid: sessionId,
      resultid: resultId,
      data: JSON.stringify(data)
    }).then(() => {
      reply(view)
    })
  })
}
