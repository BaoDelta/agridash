import sql from "app/core/utils/sql"
import cache from "app/core/utils/cache"

function getCacheKey(sessionId, resultId) {
  return `georesult/${sessionId}/${resultId}`
}

export function checkExists(sessionId, resultId) {
  return cache.get(getCacheKey(sessionId, resultId)).then(found => {
    if (found) {
      return found
    }
    return sql("georesult").select("timestamp").where({
      sessionid: sessionId,
      resultid: resultId
    }).then(results => {
      return !!results.length
    })
  })
}

export function createResult(sessionId, resultId, data) {
  return sql("georesult").insert({
    sessionid: sessionId,
    resultid: resultId,
    data: JSON.stringify(data)
  }).then(result => {
    return cache.set(getCacheKey(sessionId, resultId), true).then(() => result)
  })
}
