import sql from "app/core/utils/sql"
import {fromCache, del, TTL_LONG} from "app/core/utils/cache"
import {findById as findUserById} from "app/core/models/user"

function beforeCache(report) {
  if (!report) {
    return report
  }
  const {createdat: createdAt, "author_id": authorId, ...others} = report
  return {
    ...others,
    authorId,
    createdAt
  }
}

function afterCache(report) {
  if (!report) {
    return report
  }
  const {authorId, ...others} = report
  return findUserById(report.authorId)
  .then(author => ({
    ...others,
    author
  }))
}

export function findById(id) {
  return fromCache(`report/${id}`, TTL_LONG, () => sql.first().from("report").where("id", id), beforeCache, afterCache)
}

export function clearCache(id) {
  return del(`report/${id}`)
}

export function create(report) {
  const {author, ...others} = report
  return sql.insert({
    ...others,
    "author_id": author.id
  }).into("report").returning("id")
  .then(([id]) => {
    return clearCache(id)
    .then(() => findById(id))
  })
}
