import sql from "app/core/utils/sql"
import {fromCache, del, TTL_LONG} from "app/core/utils/cache"

export function findById(id) {
  return fromCache(`report/${id}`, TTL_LONG, () => sql.first().from("report").where("id", id))
  .then(report => {
    if (!report) {
      return report
    }
    const {createdat: createdAt, "appuser_id": userId, ...others} = report
    return {
      ...others,
      userId,
      createdAt
    }
  })
}

export function removeReportCache(id) {
  return del(`report/${id}`)
}

export function create(report) {
  return removeReportCache(report.id)
  .then(() => {
    const {userId, ...others} = report
    return sql.insert({
      ...others,
      "appuser_id": userId
    }).into("report").returning("id")
    .then(([id]) => findById(id))
  })
}
