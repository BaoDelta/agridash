import sql from "app/core/utils/sql"
import {fromCache, del, TTL_SHORT} from "app/core/utils/cache"

export function findByUsername(username, requireHash) {
  return fromCache(`user/${username}`, TTL_SHORT, () => sql.first().from("appuser").where("username", username)
  .then(user => {
    if (!user) {
      return user
    }
    const {id, createdat, ...others} = user
    return {
      ...others,
      id: +id,
      createdAt: createdat
    }
  }))
  .then(user => {
    if (!user || requireHash) {
      return user
    }
    const {hash, ...userWithoutHash} = user
    return userWithoutHash
  })
}

export function create(user) {
  return del(`user/${user.username}`).then(() => {
    return sql.insert(user).into("appuser")
    .then(() => findByUsername(user.username))
  })
}
