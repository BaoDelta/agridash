import fs from "fs"
import path from "path"
import Download from "download"
import config from "app/config"

const cdnPath = path.resolve("tmp/cdn")

export function register(server, options, next) {
  if (config.cdn.cache) {
    server.route({
      method: "GET",
      path: `${config.cdn.cache}/{path*}`,
      handler: (request, reply) => {
        const filePath = path.join(cdnPath, request.params.path)
        fs.stat(filePath, notFound => {
          if (notFound) {
            new Download()
              .get(`${config.cdn.url}/${request.params.path}`)
              .dest(path.join(filePath, ".."))
              .run(() => {
                reply.file(filePath)
              })
            return
          }
          reply.file(filePath)
        })
      }
    })
  }
  next()
}

register.attributes = {
  name: "agridash-vendors"
}
