import {last} from "app/utils"
import {load} from "app/block/loader"
import {findAll as findAllStates} from "app/models/state"

function groupByState(config) {
  const promises = []
  config.fields.forEach(field => {
    promises.push(load(field))
  })
  promises.push(findAllStates())
  return Promise.all(promises).then(data => {
    const records = []
    const recordById = {}
    last(data).forEach(state => {
      const record = {
        id: state.id,
        name: state.name
      }
      records.push(record)
      recordById[record.id] = record
    })
    config.fields.forEach((field, index) => {
      data[index].forEach(entry => {
        const record = recordById[entry.stateid]
        record[field.id] = entry.value
      })
    })
    return records
  })
}

export default groupByState
