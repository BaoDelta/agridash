import path from "path"
import {Server} from "hapi"
import {createLogger} from "bunyan"

const config = require(path.resolve("src/config"))

const log = createLogger({name: "server"})

const server = new Server()
server.connection({
  labels: ["web"],
  host: config.web.host,
  port: config.web.port
})
server.connection({
  labels: ["api"],
  host: config.api.host,
  port: config.api.port
})
server.connection({
  labels: ["tile"],
  host: config.tile.host,
  port: config.tile.port
})

function handleError(error) {
  if (error) {
    throw error
  }
}

server.connections.forEach(connection => {
  const label = connection.settings.labels[0]
  server.select(label).register({
    register: require("app/" + label),
    options: config
  }, handleError)
})

server.start(() => {
  server.connections.forEach(connection => {
    log.info("Server " + connection.settings.labels[0] + " running at: " + connection.info.uri)
    if (config.debug.showRoutes) {
      log.info({
        routes: connection.table().map(route => route.path)
      })
    }
  })
})
