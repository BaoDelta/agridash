import mapnik from "mapnik"
import createMap from "app/tile/handlers/createMap"

function renderImage(request) {
  return createMap(request).then(map => new Promise((resolve, reject) => {
    const image = new mapnik.Image(map.width, map.height)
    map.render(image, error => {
      if (error) {
        reject(error)
        return
      }
      resolve(image)
    })
  }))
}

renderImage.then = reply => image => {
  reply(image.encodeSync("png")).type("image/png")
}

export default renderImage
