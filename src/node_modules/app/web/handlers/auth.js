import bcrypt from "bcryptjs"
import {findByUsername} from "app/core/models/user"

export function login(request) {
  const {username, password} = request.payload
  return findByUsername(username, true).then(user => new Promise((resolve, reject) => {
    if (!user) {
      reject(`User ${username} not found`)
      return
    }
    bcrypt.compare(password, user.hash, (err, result) => {
      if (err) {
        reject(err)
        return
      }
      if (!result) {
        reject(`Password does not match for ${username}`)
        return
      }
      const {hash, ...userWithoutHash} = user
      request.auth.session.set(userWithoutHash)
      resolve(userWithoutHash)
    })
  }))
}

export function logout(request, reply) {
  request.auth.session.clear()
  reply.redirect("/")
}
