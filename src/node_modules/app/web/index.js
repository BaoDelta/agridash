import path from "path"
import Inert from "inert"
import {createReactHandler} from "app/web/handlers"

export function register(server, config, next) {
  server.register([{
    register: require("app/web/proxy"),
    options: config
  }, Inert], next)
  server.path(path.join(__dirname, "public"))
  const renderReact = createReactHandler({
    vendors: config.vendors,
    publicPath: config.webpack.publicPath,
    clientConfig: {
      apiUrl: config.api.url,
      tileUrl: config.tile.url
    }
  })
  server.route([
    {
      method: "GET",
      path: "/favicon.ico",
      handler: {file: "./favicon.ico"},
      config: {cache: {expiresIn: 86400000, privacy: "public"}}
    },
    {
      method: "GET",
      path: "/public/{path*}",
      handler: {directory: {path: "./"}}
    },
    {
      method: "GET",
      path: "/{path*}",
      handler: renderReact
    }
  ])
  next()
}

register.attributes = {
  name: "agridash-web"
}
