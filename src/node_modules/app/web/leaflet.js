import React from "react"
import {render, unmountComponentAtNode} from "react-dom"
import {assign, remove} from "app/core/utils"

const {L} = window
const controlAddTo = L.Control.prototype.addTo
const controlRemove = L.Control.prototype.remove
const mapClearControlPos = L.Map.prototype._clearControlPos

assign(L.Control.prototype, {
  addTo(map) {
    map._controls = map._controls || []
    map._controls.push(this)
    return controlAddTo.call(this, map)
  },
  remove() {
    if (this._map) {
      remove(this._map._controls, this)
    }
    return controlRemove.call(this)
  }
})

assign(L.Control, {
  fromReact(Control, options) {
    return L.Control.extend({
      options,
      onAdd() {
        const container = L.DomUtil.create("div", "")
        render(<Control options={options}/>, container)
        return container
      },
      onRemove() {
        unmountComponentAtNode(this.getContainer())
      }
    })
  }
})

assign(L.Map.prototype, {
  _clearControlPos() {
    if (this._controls) {
      this._controls.forEach(control => {
        control.remove()
      })
      this._controls = null
    }
    mapClearControlPos.call(this)
  }
})

export default L
