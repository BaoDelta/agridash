import React from "react"
import {Route, Redirect} from "react-router"
import {getState} from "app/web/store"
import App from "app/web/views/App"
import Report from "app/web/views/Report"
import About from "app/web/views/About"
import NotFound from "app/web/views/NotFound"
import NewReportForm from "app/web/views/NewReportForm"
import LoginForm from "app/web/views/LoginForm"
import Logout from "app/web/views/Logout"
import SignupForm from "app/web/views/SignupForm"

function authRequired(nextState, replaceState) {
  const {info} = getState()
  if (!info.user) {
    replaceState({nextPath: nextState.location.pathname}, "/login")
  }
}

function unAuthRequired(nextState, replaceState) {
  const {info} = getState()
  if (info.user) {
    replaceState(null, `/user/${info.user.username}`)
  }
}

const routes = <Route path="/" component={App}>
  <Route path="login" component={LoginForm} onEnter={unAuthRequired}/>
  <Route path="logout" component={Logout}/>
  <Route path="signup" component={SignupForm} onEnter={unAuthRequired}/>
  <Route path="report">
    <Route path="new" component={NewReportForm} onEnter={authRequired}/>
    <Route path=":id" component={Report}/>
    <Route path=":id/view/:viewId" component={Report}/>
  </Route>
  <Route path="about" component={About}/>
  <Redirect from="/r/:id" to="/report/:id"/>
  <Redirect from="/r/:id/v/:viewId" to="/report/:id/view/:viewId"/>
  <Redirect from="/report/:id/v/:viewId" to="/report/:id/view/:viewId"/>
  <Redirect from="/r/:id/view/:viewId" to="/report/:id/view/:viewId"/>
  <Route path="*" component={NotFound}/>
</Route>

export default routes
